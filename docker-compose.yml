# ===========================================
# Local development / reference compose file
# In production, Coolify manages each service separately.
# ===========================================
#
# This file is for LOCAL TESTING ONLY.
# Now using PocketBase instead of Supabase + MinIO.
#
# Usage:
#   1. Deploy PCD App via Coolify
#   2. Deploy PocketBase via Coolify (or use this compose for local dev)
#   3. Build and run PCD app pointing to PocketBase

services:
  # ---- PocketBase (self-hosted BaaS) ----
  # Avoid ports 8000, 8080, 9000 - reserved by Coolify
  # Uses GitHub Container Registry (requires GitHub token in Coolify)
  pocketbase:
    image: ghcr.io/pocketbase/pocketbase:latest
    container_name: pocketbase
    ports:
      - "8090:8090"
    environment:
      PB_ENCRYPTION_ENV: "off"  # For local dev only
      PB_DATA_DIR: "/pb_data"
    volumes:
      - pocketbase_data:/pb_data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "--tries=1", "http://localhost:8090/_/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---- PCD App ----
  pcd-app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_POCKETBASE_URL: ${VITE_POCKETBASE_URL:-http://pocketbase:8090}
    ports:
      - "8022:80"
    depends_on:
      - pocketbase

volumes:
  pocketbase_data:
