# ===========================================
# Local development / reference compose file
# In production, Coolify manages each service separately.
# ===========================================
#
# This file is for LOCAL TESTING ONLY.
# It does NOT include the full Supabase stack (use Coolify's
# one-click Supabase template for that).
#
# Usage:
#   1. Deploy Supabase via Coolify (or supabase start locally)
#   2. Deploy MinIO via Coolify (or use this compose for MinIO)
#   3. Build and run the PCD app pointing to those services

services:
  # ---- MinIO (S3-compatible storage) ----
  # Avoid ports 8000, 8080, 9000 â€” reserved by Coolify
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9010:9000"   # S3 API (external: 9010, internal: 9000)
      - "9011:9001"   # MinIO Console (external: 9011, internal: 9001)
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Create default buckets on startup (runs once and exits)
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    restart: "no"
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 $${MINIO_ROOT_USER:-minioadmin} $${MINIO_ROOT_PASSWORD:-minioadmin};
      mc mb --ignore-existing local/supabase-storage;
      mc anonymous set download local/supabase-storage;
      echo 'Bucket init complete.';
      "

  # ---- PCD App ----
  pcd-app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:-http://localhost:8000}
        VITE_SUPABASE_PUBLISHABLE_KEY: ${VITE_SUPABASE_PUBLISHABLE_KEY:-your-anon-key}
    ports:
      - "8022:80"
    depends_on:
      - minio

volumes:
  minio_data:
